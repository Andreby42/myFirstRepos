<!DOCTYPE html>
<html>
  <head>
    <title>新建活动</title>
   	
  <script src="${request.getContextPath()}/scripts/boot.js" type="text/javascript"></script>
	<script type="text/javascript" src="${request.getContextPath()}/js/pw-common.js"></script>
    <!--<link rel="stylesheet" type="text/css" href="./styles.css">-->
     <script type="text/javascript" src="${request.getContextPath()}/js/jquery-foxibox-0.2.min.js"></script>
	<link rel="stylesheet" href="${request.getContextPath()}/css/jquery-foxibox-0.2.css" type="text/css"></link>
	<script type="text/javascript" src="${request.getContextPath()}/js/ajaxfileupload.js"></script>
  </head>
  
  <body>
<!--  ${activitydateTime} -->
<!--    <form id="t4ui_userReg"  method="post" action="${request.getContextPath()}/controller/activity/saveActivityPic" enctype="multipart/form-data">  -->
  	<div id="actvityInfoForm">
  	  <table border="0" cellpadding="1" cellspacing="2" style="width:100%;table-layout:fixed;">
	 		<div class="t4ui_userInf">活动基本信息</div>
	    <tr>
	        <td style="width:100px;">发布人：</td>
	        <td style="width:50%;">
	        <input type="hidden" id="issuerCode" value = "${usercode}"/>
	            <input id="issuer" name="issuer" class="mini-textbox" style="width:100%;" required="true" value = "${username}" maxlength="30"/>
	        </td>
	        <td style="width:100px;">活动代码：</td>
	        <td style="width:50%">
	            <input id="activityCode" name="activityCode" class="mini-textbox" style="width:100%;" required="true" maxlength="30"/>
	        </td>

	        <td style="width:100px;">活动名称：</td>
	        <td style="width:50%">
	        	<input id="activityName" name="activityName" class="mini-textbox" style="width:100%;" required="true" maxlength="30"/>
	        </td>
	    </tr>
	    <tr>
	    	<td style="width:100px;">活动起始时间：</td>
	    	<td style="width:50%">
	    		<input id="activityStartTime" name="activityStartTime" required="true" class="mini-datepicker" style="width: 100%"/>
	    	</td>
	    	<td style="width:100px;">活动截止时间：</td>
	    	<td style="width:50%">
	    		<input id="activityEndTime" name="activityEndTime" required="true" class="mini-datepicker" style="width: 100%"/>
	    	</td>
	  		<td style="width:60px;">选择机构：</td>
	        <td style="width:100%">
	            <input id="orgscopeadd" style="width:100%;" 
							name="orgscopeadd" class="mini-buttonedit" allowinput="false" align="center"
							emptytext="请选择机构" required="true" onbuttonclick="loadFrame();" />
	        </td>
	        <input name="isFirst" id="isFirst" class="mini-hidden" />
	        <input name="org" id="org" class="mini-hidden" /> 
	          <input   name="activityPhotoName" id="activityPhotoName" class="mini-hidden" /> 
	    </tr>
	</table>
	<!-- 	<div style="border:1px solid #BCBCBC;width:1000px;height:220px;margin-top:10px;margin-left: 10px; ">
		<div class="t4ui_userInf">活动展现元素</div>
		<table>
		 			<tr style="margin-top:10px;height:30px;">
		 				<td><span style="margin-left: 20px;">活动列表展示图：</td>
		 				<td>
		 					<img id="userPic" style="width:270px;height:160px;"/>
		 				</td>
		 				<td>
		 				
							<input type="file" id="myfile" name ="myfile" style="width:200px;" />
							<td><a href="#" onclick="ajaxFileUpload('picFile')">上传</a></td>
							//<td><a href="#" onclick="removePics()">删除</a>
		    				<input type="hidden" id="fileName" />
		    				<input type="hidden" id="filePath" />
		 				</td>
		 			</tr>
		 			<tr>
		 				<td>
		 					<input type="button" style="margin-left: 10px"  onclick="copyRow()" value="新增详情页"/>
		 				</td>
		 				<td></td>
		 				<td></td>
		 			</tr>
		    	</table>
        </div> -->
  <!--      </form> -->
        新增子页面信息
  <iframe onload="iFrameHeight()" id="templateframe" frameborder="0" style="width:100%;margin-bottom: 20px" border="0" scrolling="no"  src="${request.getContextPath()}/controller/activity/initActivityPicList"></iframe>
	    	<div id="table_0" style="border:1px solid #BCBCBC;width:1000px;height: 300px;margin-top:10px;margin-left: 10px; "> 
		    	<table>
		 			<tr style="margin-top:10px;height:30px;">
		 				<td><span style="margin-left: 20px;">活动详情展示图：</td>
		 				<td>
		 					<img id="userPic_0" style="width:270px;height:160px;"/>
		 				</td>
		 				<td>
							<!-- <input class="mini-htmlfile"  type="file" id="picFile_0" name="picFile_0"> -->
					<!-- 		<input id="picFile_0" class="mini-fileupload" name="picFile_0" />
							<input id="fileupload1" class="mini-fileupload" name="fileupload1" limitType="*.txt"  /> -->
							<input id="picFile_0"  type="file" name="picFile_0"/>
    
						 </td>
						<td><a class="mini-button"	onclick="ajaxFileUpload('picFile_0')">上传</a> </td>
					<!-- 	<td><a href="mini-button" onclick="removePic(0)">删除</a>
							<input type="text"  id="activityFileid" name ="activityFileid" value="" />
		    				<input type="hidden" id="fileName_0" />
		    				<input type="hidden" id="filePath_0" />
		 				</td> -->
		 				<!-- <td style="width:15px">
							 <input type="button" style="margin-left: 10px"   value="删除详情页" onclick="removeButton(0)" /> 
		 				</td> -->
		 			</tr>
		 			<tr >
		 				<td><span style="margin-left: 20px;">活动详情说明：</span></td>
		 				<td colspan="5">
		 					<textarea id="content" name ="content" style="width: 484px;height: 100px;resize:none;" maxlength="400" >
		 					</textarea>
		 				</td>
		 			</tr>
		    	</table>
		    </div>
        <div class="mini-toolbar" style="right:0px;position: fixed;z-index:2;bottom: 0px">
			<a class="mini-button" onclick="javascript:lastStep()">返回</a>
			<a class="mini-button" onclick="javascript:editProductTemplate()">保存</a>
			<a class="mini-button" onclick="submitCheck()">提交审核</a>
		</div>
	</div>	
  </body>
  <script type="text/javascript">
  	mini.parse();
  	window.onload=load;
  	function load(){
  		mini.get("issuer").setValue("${username}");
  	//	var date = new Date().Format("yyyyMMddhhmmssS");
		mini.get("activityCode").setValue("${activitydateTime}");
		//mini.get("activityId").setValue(date);
	}
/* 	 Date.prototype.Format = function(fmt) { //author: meizz 
  var o = { 
    "M+" : this.getMonth()+1,                 //月份 
    "d+" : this.getDate(),                    //日 
    "h+" : this.getHours(),                   //小时 
    "m+" : this.getMinutes(),                 //分 
    "s+" : this.getSeconds(),                 //秒 
    "q+" : Math.floor((this.getMonth()+3)/3), //季度 
    "S"  : this.getMilliseconds()             //毫秒 
  }; 
  if(/(y+)/.test(fmt)) 
    fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length)); 
  for(var k in o) 
    if(new RegExp("("+ k +")").test(fmt)) 
  fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length))); 
  return fmt; 
} */ 
  /* 	var row_index = 0;
	var row_num = "0,";
	function copyRow(){
		debugger;
		var rowStr = row_num.split(",");
		var len = rowStr.length;
		if(len>5){
			mini.alert("最多只能5条!");
			return;
		}
		row_index++;
		row_num += row_index + ",";
		var div_0 = $("#tables")
		var div = "<div id='table_"+row_index+"' style='border:1px solid #BCBCBC;width:1000px;height: 300px;margin-top:10px;margin-left: 10px; '>"
				+"<table>"
				+	"<tr style='margin-top:10px;height:30px;'>"
				+		"<td><span style='margin-left: 20px;'>活动详情展示图：</td>"
				+		"<td>"
				+		"<img id='userPic_"+row_index+"' style='width:270px;height:160px;'/>"
				+		"</td>"
				+		"<td>"
				+		"<input  type='file' id='picFile_"+row_index+"' name='picFile_"+row_index+"'></td>" 
				+		"<td><a href='#' onclick='ajaxFileUpload('picFile_"+row_index+"')'>上传</a></td>"
				+		"<td><a href='#' onclick='removePic("+row_index+")'>删除</a>"
				+		"<input type='hidden' id='fileName_"+row_index+"' />"
				+		"<input type='hidden' id='filePath_"+row_index+"' />"
				+		"</td>"
				+		"<td style='width:15px'>"
				+			"<input type='button' style='margin-left: 10px'   value='删除详情页' onclick='removeButton("+row_index+")' />"
				+		"</td>"
				+		"<tr >"
				+		"<td><span style='margin-left: 20px;'>活动详情说明：</span></td>"
				+		"<td colspan='5'>"
				+		"<textarea id='content_"+row_index+"' style='width: 484px;height: 100px;resize:none;' maxlength='400'></textarea>"
				+		"</td></tr>"
				+"</table>"
			+"</div>"
		div_0.append(div);
	}
	 */
	function editProductTemplate(){
	 var form = new mini.Form("#actvityInfoForm");
         form.validate();
         if (form.isValid() == false) {
         	return;
         }
         var orgId = mini.get("orgscopeadd").getValue();
     /*     var activity = form.getData();   
      	activity.createtime=orgId;
      		jQuery.ajax({
      		url : "${request.getContextPath()}/controller/product/saveProductInfo",
      		type : "post",
      		dataType : "json",
      		data : activity,
      		success : function(result){
      			if(result.success){
    
      			} else {
      				mini.alert(result.msg);
      			}
      		}
      	}); */
      	var activitycontent = form.getData();  
      	 activitycontent.activityStartTime= mini.formatDate (mini.get("activityStartTime").getValue(), "yyyy-MM-dd");
      //	activitycontent。activityEndTime["activityEndTime"] =  mini.formatDate (mini.get("activityEndTime").getValue(), "yyyy-MM-dd");
      	activitycontent.activityEndTime =  mini.formatDate (mini.get("activityEndTime").getValue(), "yyyy-MM-dd");
      			jQuery.ajax({
      		url : "${request.getContextPath()}/controller/activity/saveActivityPic",
      		type : "post",
      		dataType : "json",
      		data : activitycontent,
      		success : function(result){
      				window.location.href="${request.getContextPath()}/controller/activity/init";
      			
      		}
      	});
	
	}
	
	function submitCheck(){
	 var form = new mini.Form("#actvityInfoForm");
         form.validate();
         if (form.isValid() == false) {
         	return;
         }
         var orgId = mini.get("orgscopeadd").getValue();
     /*     var activity = form.getData();   
      	activity.createtime=orgId;
      		jQuery.ajax({
      		url : "${request.getContextPath()}/controller/product/saveProductInfo",
      		type : "post",
      		dataType : "json",
      		data : activity,
      		success : function(result){
      			if(result.success){
    
      			} else {
      				mini.alert(result.msg);
      			}
      		}
      	}); */

      	var activitycontent = form.getData();  
      	activitycontent.activityStartTime= mini.formatDate (mini.get("activityStartTime").getValue(), "yyyy-MM-dd");
      //	activitycontent。activityEndTime["activityEndTime"] =  mini.formatDate (mini.get("activityEndTime").getValue(), "yyyy-MM-dd");
      	activitycontent.activityEndTime =  mini.formatDate (mini.get("activityEndTime").getValue(), "yyyy-MM-dd");
      	activitycontent.status="2";
      		jQuery.ajax({
      		url : "${request.getContextPath()}/controller/activity/saveActivityPic",
      		type : "post",
      		dataType : "json",
      		data : activitycontent,
      		success : function(result){
      		  		mini.alert("已提交审核");
      				window.location.href="${request.getContextPath()}/controller/activity/init";
      			
      		}
      	});
              /*  document.getElementById("t4ui_userReg").submit(); */
                  return;  
              // window.location.href="${request.getContextPath()}/controller/activity/init";
	
	}
	// 删除
	function removeButton(num){
		var rowStr = row_num.split(",");
		var len = rowStr.length;
		if(len == 2){
			mini.alert("最后一条活动详情,不能删除");
			return;
		}
		$("#table_"+num).remove();
		row_num = row_num.replace(num+",","");
	}
  	function lastStep(){
		window.location.href="${request.getContextPath()}/controller/activity/init";
	}
    function ajaxFileUpload(upload) {
    	var fileValue = document.getElementById("picFile_0").value;
    	//var fileValue = mini.get(upload).value;// 获得文件内容
    	var fileValue3 = $("#content").val();// 获得文件内容
    	//var fileValue3 = cont
    	var activityCode =  mini.get("activityCode").value ; 
    	var fileData = {"activityCode":activityCode,"fileValue3":fileValue3} ;
    	if(fileValue3 == ""){
    	alter("ninin");
    	return ;
    	}
/*    		var fileValue1= mini.get("picFile_0").getValue();// 获得文件内容 
		var fileValue2 = document.getElementById("picFile_0");// 获得文件内容  
		var fileValue22 = mini.get(upload).getValue();// 获得文件内容 */ 
		//var userCode = mini.get("userCode").getValue(); 
		if (fileValue != "") {
			var lastName = fileValue.substring(fileValue.indexOf("."));
			lastName = lastName.toLocaleLowerCase();
			if (lastName == ".png" || lastName == ".jpg") {

			} else {
				mini.alert("导入文件只支持表格上传,表格格式例如.png、.jpg!");
				return;
			}
			var urlto  = "${request.getContextPath()}/controller/activity/saveActivityPicture";//?activityCode="+activityCode+"&fileValue3="+fileValue3;
			//var urlpost = encodeURI(urlto);
			jQuery.ajaxFileUpload({
				secureuri : false,
				//contentType:"application/json",
				url : urlto,
				fileElementId : upload, //文件选择框的id属性
				dataType : "json",
      			data :{activityCode:activityCode,fileValue3:fileValue3,content:fileValue3},
				success : function(data, status) //相当于java中try语句块的用法
				{
				   $("#content").val("");
				   $("#picFile_0").val("");
				   $("#templateframe").attr("src","${request.getContextPath()}/controller/activity/initActivityPicList?acitivitycode="+activityCode);
				   $("table_0").load(function(){
				   	alert("finish");
				   });
				   var form = new mini.Form("#table_0");
				   form.clear();
				},
				error : function(data, status, e) //相当于java中catch语句块的用法
				{
					$('#__content__').html('添加失败');
				}
			});
		} else {
			mini.alert("请选择文件");
			return;
		}
	}
	 //弹出机构单选树 新增 
	function onButtonEditOrg(e) {
	var btnEdit = this;
	var receiveOrg = mini.get("receiveOrg");
	mini.open( {
		url : "${request.getContextPath()}/controller/activity/orgSelecter",
		showMaxButton : false,
		title : "选择树",
		width : 600,
		height : 400,
		onload : function() {
			var iframe = this.getIFrameEl();
			iframe.contentWindow.SetData(receiveOrg.getValue());
		},
		ondestroy : function(action) {
			if (action == "ok") {
				var iframe = this.getIFrameEl();
				var selectOrgs = iframe.contentWindow.GetData();
				var orgNames = [];
				var orgIds = [];
				for (var i=0; i < selectOrgs.length; i ++) {
					orgNames.push(selectOrgs[i].name);
					orgIds.push(selectOrgs[i].id);
				}
				var orgIdString = orgIds.join(",");
				btnEdit.setValue(orgIdString);
				btnEdit.setText(orgNames.join(","));
			}
		}
	});
			
}
function removePic(i){
	$("#fileName_"+i).val("");
	$("#filePath_"+i).val("");
	$("#picFile_"+i).val("");
	document.getElementById("userPic_"+i).src = "";
}
function removePics(){
	$("#fileName").val("");
	$("#filePath").val("");
	$("#picFile").val("");
	document.getElementById("userPic").src = "";
}
   
function CloseWindow(action) {
    if (window.CloseOwnerWindow) return window.CloseOwnerWindow(action);
    else window.close();
  }
  
  function iFrameHeight() {
		var ifm = document.getElementById("templateframe");
		var subWeb = document.frames ? document.frames["templateframe"].document
				: ifm.contentDocument;
		if (ifm != null && subWeb != null) {
			ifm.height = subWeb.body.scrollHeight;
			ifm.width = subWeb.body.scrollWidth;
		}
	}
	
	  //弹出机构单选树 新增 
function loadFrame() {
	var isFirst = document.getElementById("isFirst");
    var orgObj=document.getElementById("org").value;;
   /* $("#roleid").val("");
     if (isFirst.value == "") {
        jQuery.getJSON("${request.getContextPath()}/controller/role/querySessionOrg",function(text){
        orgObj = text.msg;
  		 });
    }else{
    	orgObj = document.getElementById("org").value;
    }*/
    

    var array = new Array();
    mini.open({
        url: "${request.getContextPath()}/views/activity/activity_addOrg.html",
        showMaxButton: false,
        title: "选择机构",
        width: 600,
        height: 450,
        onload: function() {
            var iframe = this.getIFrameEl();
            var productId = "${request.getParameter('productId')}";
            array[0] = productId;
            array[1] = orgObj;
            array[2] = isFirst.value;
            iframe.contentWindow.SetData(array);
        },
        ondestroy: function(action) {
            if (action == "ok") {
                var iframe = this.getIFrameEl();
                var data = iframe.contentWindow.GetData();
                data = mini.clone(data);
                 var orgNameStr="";
                    var orgStr = "";
                if (data[0]) {
                    if(data[0] == "1"){
                    	isFirst.value = data[0];
                    }else{
                    	isFirst.value = data[0].isFirst;
                    
                    for (var i = 0; i < data.length; i++) {
                        if (i == data.length - 1) {
                            orgStr = orgStr + data[i].id;
                        } else {
                            orgStr = orgStr + data[i].id + ",";
                        }
                    }
                   
                    for (var i = 0; i < data.length; i++) {
                        if (i == data.length - 1) {
                            orgNameStr = orgNameStr + data[i].name;
                        } else {
                            orgNameStr = orgNameStr + data[i].name + ",";
                        }
                    }
                    }
                    mini.get("orgscopeadd").setValue(orgStr);
					mini.get("orgscopeadd").setText(orgNameStr);
                    document.getElementById("org").value = orgStr;
                }
            }
        }
    });
}
  </script>
</html>
